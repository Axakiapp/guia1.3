// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
// categories
const categories = ["Alimentação","Beleza","Saúde","Serviços","Comércio","Automotivo","Profissionais Autônomos"];
const catGrid = document.getElementById('catGrid');
const categorySelect = document.getElementById('categorySelect');
const searchInput = document.getElementById('searchInput');
const citySelect = document.getElementById('citySelect');
const cardsEl = document.getElementById('cards');
// populate categories and buttons
categories.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; categorySelect.appendChild(opt); const btn=document.createElement('button'); btn.className='cat'; btn.setAttribute('data-cat',c); btn.innerHTML=`<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg><span>${c}</span>`; btn.addEventListener('click', ()=>{ document.querySelectorAll('.cat').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); categorySelect.value=c; doSearch(); }); catGrid.appendChild(btn); });
function renderCards(data){ cardsEl.innerHTML=''; if(!data||data.length===0){ cardsEl.innerHTML='<p>Nenhum resultado encontrado.</p>'; return; } data.forEach(d=>{ const div=document.createElement('div'); div.className='card'; const img=d.imageURL||''; const thumb=img?`<img class="thumb" src="${img}" alt="${d.nome}">`:`<div class="thumb">Sem foto</div>`; const whatsappLink=d.whatsapp?`https://wa.me/${d.whatsapp.replace(/\D/g,'')}`:''; const whatsappBtn=d.whatsapp?`<a href="${whatsappLink}" target="_blank" class="btn" style="padding:6px 8px;margin-right:6px">Fale no WhatsApp</a>`:''; const mapsLink=d.endereco?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.endereco + ', ' + d.cidade)}`:''; div.innerHTML=`${thumb}<div class="card-body"><h4>${d.nome}</h4><p>${d.descricao || ''}</p><div class="meta">${d.categoria || ''} • ${d.cidade || ''} • ${d.telefone || ''}</div><div class="icons">${whatsappBtn}<a href="${mapsLink}" target="_blank" class="btn" style="padding:6px 8px;margin-left:8px">Ver no mapa</a></div></div>`; cardsEl.appendChild(div); }); }
function loadActive(){ db.collection('cadastros').where('status','==','active').orderBy('createdAt','desc').onSnapshot(snap=>{ const items=[]; snap.forEach(doc=> items.push(doc.data())); renderCards(items); }); } loadActive(); async function doSearch(){ const q=searchInput.value.trim().toLowerCase(); const cat=categorySelect.value; const city=citySelect.value; const ref=db.collection('cadastros').where('status','==','active').orderBy('createdAt','desc'); const snap=await ref.get(); const results=[]; snap.forEach(doc=>{ const d=doc.data(); let matchQ=q===''|| (d.nome + ' ' + (d.descricao||'') + ' ' + (d.endereco||'')).toLowerCase().includes(q); let matchCat=cat===''|| d.categoria===cat; let matchCity=city===''|| d.cidade===city; if(matchQ&&matchCat&&matchCity) results.push(d); }); renderCards(results); } document.getElementById('searchBtn').addEventListener('click', doSearch); searchInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ doSearch(); }}); document.getElementById('viewAll').addEventListener('click', ()=>{ document.querySelectorAll('.cat').forEach(b=>b.classList.remove('active')); categorySelect.value=''; citySelect.value=''; searchInput.value=''; loadActive(); }); document.getElementById('adForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const nome=document.getElementById('f_nome').value.trim(); const endereco=document.getElementById('f_endereco').value.trim(); const bairro=document.getElementById('f_bairro').value.trim(); const cidade=document.getElementById('f_cidade').value.trim(); const telefone=document.getElementById('f_telefone').value.trim(); const whatsapp=document.getElementById('f_whatsapp').value.trim(); const email=document.getElementById('f_email').value.trim(); const descricao=document.getElementById('f_descricao').value.trim(); const imagemFile=document.getElementById('f_imagem').files[0]; if(!nome||!endereco||!bairro||!cidade){ alert('Preencha os campos obrigatórios'); return; } const docRef=db.collection('cadastros').doc(); const id=docRef.id; let imageURL=null; let imagePath=null; if(imagemFile){ imagePath=`cadastros/${id}/${imagemFile.name}`; const storageRef=storage.ref(imagePath); await storageRef.put(imagemFile); imageURL=await storageRef.getDownloadURL(); } const data={ nome, endereco, bairro, cidade, telefone, whatsapp, email, descricao, imageURL: imageURL||null, imagePath: imagePath||null, categoria: categorySelect.value||'', status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() }; docRef.set(data).then(()=>{ document.getElementById('modal').setAttribute('aria-hidden','true'); const toast=document.getElementById('toast'); toast.style.display='block'; setTimeout(()=> toast.style.display='none', 3000); document.getElementById('adForm').reset(); alert('Cadastro enviado e salvo como pendente.'); }).catch(e=> alert('Erro ao enviar: '+e.message)); }); document.getElementById('saveLocal').addEventListener('click', function(){ const data={}; new FormData(document.getElementById('adForm')).forEach((v,k)=> data[k]=v); let list=JSON.parse(localStorage.getItem('guia1_local')||'[]'); data.id=Date.now(); list.push(data); localStorage.setItem('guia1_local', JSON.stringify(list)); alert('Cadastro salvo localmente. (Apenas para testes)'); });